# Invoice Processing Workflow
# Orchestrates the complete invoice processing pipeline

main:
  params: [input]
  steps:
    - init:
        assign:
          - message_id: ${input.message_id}
          - user_email: ${default(input.user_email, "rohan.chaudhari@consuleventinc.com")}
          - project_id: "consulevent-ap-invoice"
          - dataset_id: "invoice_processing"
          - region: "us-central1"
    
    - log_start:
        call: sys.log
        args:
          text: ${"Starting invoice processing for message " + message_id}
          severity: INFO
    
    # Step 1: Process Email and Extract Attachments
    - process_email:
        call: http.post
        args:
          url: https://us-central1-consulevent-ap-invoice.cloudfunctions.net/invoice-email-processor
          auth:
            type: OIDC
          body:
            message_id: ${message_id}
            user_email: ${user_email}
        result: email_result
    
    - check_email_result:
        switch:
          - condition: ${email_result.body.status == "error"}
            next: handle_error
          - condition: ${len(email_result.body.processed_files) == 0}
            next: no_files_to_process
    
    - log_files_found:
        call: sys.log
        args:
          text: ${"Found " + string(len(email_result.body.processed_files)) + " PDF files"}
          severity: INFO
    
    # Step 2: Process Each PDF
    - init_results:
        assign:
          - processed_invoices: []
          - exception_invoices: []
          - failed_invoices: []
    
    - process_pdfs:
        for:
          value: pdf_file
          in: ${email_result.body.processed_files}
          steps:
            - log_processing_pdf:
                call: sys.log
                args:
                  text: ${"Processing " + pdf_file.filename}
                  severity: INFO
            
            # Step 2a: Document AI Extraction
            - extract_data:
                call: http.post
                args:
                  url: https://us-central1-consulevent-ap-invoice.cloudfunctions.net/invoice-document-ai-processor
                  auth:
                    type: OIDC
                  body:
                    gcs_uri: ${pdf_file.gcs_uri}
                    document_type: "invoice"
                result: extraction_result
            
            - check_extraction:
                switch:
                  - condition: ${extraction_result.body.status == "error"}
                    steps:
                      - add_to_failed:
                          assign:
                            - failed_invoices: ${list.concat(failed_invoices, [pdf_file.filename])}
                      - continue_next_pdf:
                          next: continue
            
            # Step 2b: Assign extracted data
            - assign_extracted_data:
                assign:
                  - final_data: ${extraction_result.body.extracted_data}
            
            # Step 2c: Check if Gemini synthesis is needed
            - check_synthesis_needed:
                switch:
                  - condition: ${len(extraction_result.body.needs_synthesis) > 0}
                    steps:
                      - run_synthesis:
                          call: http.post
                          args:
                            url: https://us-central1-consulevent-ap-invoice.cloudfunctions.net/invoice-gemini-synthesis
                            auth:
                              type: OIDC
                            body:
                              raw_text: ${extraction_result.body.raw_text_preview}
                              fields_to_improve: ${extraction_result.body.needs_synthesis}
                              existing_data: ${extraction_result.body.extracted_data}
                            timeout: 300
                          result: synthesis_result
                      
                      - merge_synthesis_data:
                          assign:
                            - final_data: ${map.merge(extraction_result.body.extracted_data, synthesis_result.body.improved_data)}
            
            # Step 2d: Validate Invoice
            - validate_invoice:
                call: http.post
                args:
                  url: https://us-central1-consulevent-ap-invoice.cloudfunctions.net/invoice-validation-engine
                  auth:
                    type: OIDC
                  body:
                    invoice_data: ${final_data}
                result: validation_result
            
            # Step 2e: Route to appropriate list
            - route_invoice:
                switch:
                  - condition: ${validation_result.body.is_exception}
                    steps:
                      - add_to_exceptions:
                          assign:
                            - exception_record:
                                filename: ${pdf_file.filename}
                                gcs_uri: ${pdf_file.gcs_uri}
                                extracted_data: ${final_data}
                                is_exception: ${validation_result.body.is_exception}
                                exceptions: ${validation_result.body.exceptions}
                                exception_count: ${validation_result.body.exception_count}
                            - exception_invoices: ${list.concat(exception_invoices, [exception_record])}
                  - condition: true
                    steps:
                      - add_to_processed:
                          assign:
                            - processed_record:
                                filename: ${pdf_file.filename}
                                gcs_uri: ${pdf_file.gcs_uri}
                                extracted_data: ${final_data}
                            - processed_invoices: ${list.concat(processed_invoices, [processed_record])}
    
    # Step 3: Write to BigQuery
    - write_processed_to_bq:
        for:
          value: invoice
          in: ${processed_invoices}
          steps:
            - insert_processed_invoice:
                call: googleapis.bigquery.v2.tabledata.insertAll
                args:
                  projectId: ${project_id}
                  datasetId: ${dataset_id}
                  tableId: "invoices_processed"
                  body:
                    rows:
                      - json:
                          invoice_id: ${default(invoice.extracted_data.invoice_id, "UNKNOWN")}
                          message_id: ${message_id}
                          filename: ${invoice.filename}
                          gcs_uri: ${invoice.gcs_uri}
                          received_date: ${text.split(text.split(sys.now(), "T")[0], " ")[0]}
                          invoice_date: ${default(invoice.extracted_data.invoice_date, null)}
                          supplier_name: ${default(invoice.extracted_data.supplier_name, null)}
                          total_amount: ${default(invoice.extracted_data.total_amount, null)}
                          net_amount: ${default(invoice.extracted_data.net_amount, null)}
                          total_tax_amount: ${default(invoice.extracted_data.total_tax_amount, null)}
                          currency: ${default(invoice.extracted_data.currency, null)}
                          raw_extracted_data: ${invoice.extracted_data}
    
    - write_exceptions_to_bq:
        for:
          value: exception
          in: ${exception_invoices}
          steps:
            - generate_exception_id:
                assign:
                  - exception_id: ${message_id + "-" + exception.filename}
            
            - insert_exception:
                call: googleapis.bigquery.v2.tabledata.insertAll
                args:
                  projectId: ${project_id}
                  datasetId: ${dataset_id}
                  tableId: "exceptions"
                  body:
                    rows:
                      - json:
                          exception_id: ${exception_id}
                          invoice_id: ${default(exception.extracted_data.invoice_id, "UNKNOWN")}
                          message_id: ${message_id}
                          filename: ${exception.filename}
                          gcs_uri: ${exception.gcs_uri}
                          received_date: ${text.split(text.split(sys.now(), "T")[0], " ")[0]}
                          invoice_date: ${default(exception.extracted_data.invoice_date, null)}
                          supplier_name: ${default(exception.extracted_data.supplier_name, null)}
                          total_amount: ${default(exception.extracted_data.total_amount, null)}
                          exception_type: ${exception.exceptions[0].type}
                          exception_severity: ${exception.exceptions[0].severity}
                          all_exceptions: ${exception.exceptions}
                          status: "PENDING"
                          raw_extracted_data: ${exception.extracted_data}
    
    # Step 4: Return Final Results
    - return_results:
        return:
          status: "success"
          message_id: ${message_id}
          total_processed: ${len(processed_invoices)}
          total_exceptions: ${len(exception_invoices)}
          total_failed: ${len(failed_invoices)}
          summary:
            written_to_bq_processed: ${len(processed_invoices)}
            written_to_bq_exceptions: ${len(exception_invoices)}
    
    # Error Handlers
    - no_files_to_process:
        return:
          status: "success"
          message: "No PDF files found"
          message_id: ${message_id}
    
    - handle_error:
        return:
          status: "error"
          message: "Workflow failed"